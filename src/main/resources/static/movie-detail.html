<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜í™” ìƒì„¸</title>
  <style>
    body { font-family: Arial; max-width: 800px; margin: 2rem auto; padding: 1rem; }
    img { max-width: 200px; margin-bottom: 1rem; }
    textarea { margin-top: 1rem; width: 100%; padding: 0.5rem; }
    button { margin-top: 0.5rem; padding: 0.5rem 1rem; }
  </style>
</head>
<body>

<h1>ğŸï¸ ì˜í™” ìƒì„¸ ì •ë³´</h1>
<div id="movie-detail">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
<button onclick="history.back()">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

<hr>

<h3>ğŸ’¬ í•œì¤„í‰</h3>
<input type="text" id="review-writer" placeholder="ì‘ì„±ì ì´ë¦„" style="width:20%; margin-bottom: 0.5rem; padding: 0.5rem;">
<textarea id="review-content" rows="3" placeholder="í•œì¤„í‰ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
<button onclick="submitReview()">ë“±ë¡</button>

<ul id="review-list" style="margin-top: 1rem; padding-left: 1rem;"></ul>

<script>
  const params = new URLSearchParams(location.search);
  const movieId = params.get('id');

  async function fetchMovieDetail(id) {
    try {
      const res = await fetch(`/movies/detail/${id}`);
      if (!res.ok) throw new Error(`ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
      const movie = await res.json();

      const container = document.getElementById('movie-detail');
      container.innerHTML = `
        <h2>${movie.title}</h2>
        <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" alt="${movie.title}">
        <p><strong>ê°œë´‰ì¼:</strong> ${movie.release_date}</p>
        <p><strong>ê°ë…:</strong> ${movie.director}</p>
        <p><strong>ì¶œì—°:</strong> ${movie.actors.join(', ')}</p>
        <p><strong>ì¤„ê±°ë¦¬:</strong> ${movie.overview}</p>
      `;
    } catch (err) {
      console.error(err);
      alert("ì£„ì†¡í•©ë‹ˆë‹¤. ì˜í™” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!");
    }
  }

  async function fetchReviews(id) {
    const res = await fetch(`/api/movies/${id}/reviews`);
    if (!res.ok) return;
    const reviews = await res.json();
    const list = document.getElementById('review-list');
    list.innerHTML = reviews.map(r => `
    <li>ğŸ“ <strong>${r.writer}</strong>: ${r.content}</li>
  `).join('');
  }

  async function submitReview() {
    const writer = document.getElementById('review-writer').value.trim();
    const content = document.getElementById('review-content').value.trim();

    if (!writer) {
      alert("ì‘ì„±ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }
    if (!content) {
      alert("í•œì¤„í‰ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    const res = await fetch(`/api/movies/${movieId}/reviews`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        writer: writer,
        content: content
      })
    });

    if (res.ok) {
      document.getElementById('review-writer').value = '';
      document.getElementById('review-content').value = '';
      fetchReviews(movieId);
    } else {
      alert("ë“±ë¡ ì‹¤íŒ¨ ğŸ˜¥");
    }
  }

  if (movieId) {
    fetchMovieDetail(movieId);
    fetchReviews(movieId);
  } else {
    document.getElementById('movie-detail').textContent = "ì˜í™” IDê°€ ì—†ìŠµë‹ˆë‹¤.";
  }
</script>

</body>
</html>